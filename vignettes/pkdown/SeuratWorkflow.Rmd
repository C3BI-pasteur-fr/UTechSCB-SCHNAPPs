---
title: "Seurat workflow"
author: 
- name: Bernd Jagla
  email: bernd <DOT> jagla <AT> pasteur <DOT> fr
date: "6/7/2020"
output: 
  html_document:
    code_folding: hide
package: SCHNAPPs
bibliography: ref.bib
vignette: >
  %\VignetteIndexEntry{Follow Seurat workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}    
---



```{r, echo=FALSE, results="hide", message=FALSE}
require(knitr)
library("htmltools")
library("vembedr")
opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

Please see the scran workflow for a more indepth workflow.

```{r}
library(dplyr)
library(Seurat)
library(patchwork)
library(SCHNAPPs)
library(SingleCellExperiment)
# Load the PBMC dataset
pbmc.data <- Read10X(data.dir = "~/Downloads/filtered_gene_bc_matrices/hg19/")
# Initialize the Seurat object with the raw (non-normalized data).
pbmc <- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", min.cells = 3, min.features = 200)
pbmc

pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")

scEx = as.SingleCellExperiment(pbmc)

colnames(colData(scEx)) = c("sampleNames",   "nCount_RNA",   "nFeature_RNA", "percent.mt" , "ident"       )
colData(scEx)$barcode = rownames(colData(scEx))

rowData(scEx)$Description = ""
rowData(scEx)$id = rownames(rowData(scEx))
rowData(scEx)$symbol = rownames(rowData(scEx))


```

```{r seuratCont}

pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
pbmc <- NormalizeData(pbmc)
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

top10 <- head(VariableFeatures(pbmc), 10)

all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)

pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))


pbmc <- FindNeighbors(pbmc, dims = 1:10)
pbmc <- FindClusters(pbmc, resolution = 0.5)

pbmc <- RunUMAP(pbmc, dims = 1:10)

colData(scEx)$seurartCluster = -1
colData(scEx)[names(Idents(pbmc)),"seurartCluster"] = Idents(pbmc)
colData(scEx)$seurartCluster = as.factor(colData(scEx)$seurartCluster)

```



```{r save file,  cache=TRUE, eval=FALSE}
save(file = "seurat.pbmc.RData", list = c("scEx"))
```




Zooming into the low nFeatureRNA region reveals that no cells will be removed using the 200 threshold.

```{r, out.width='90%', fig.align='center', fig.cap='Filter based on detected genes', echo=FALSE}
knitr::include_graphics('images/2Dzoomed.png')
```


